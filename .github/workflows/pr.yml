name: Auto Label PRs

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  schedule:
    # Runs every day at 00:00 UTC to check for inactive PRs
    - cron: '0 0 * * *'

jobs:
  label-new-pr:
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Add "status: to be reviewed" label
        uses: actions/github-script@v7
        with:
          script: |
            // Remove other status labels
            const labelsToRemove = ['status: in review', 'status: pending-request-changes', 'status: inactive'];
            const currentLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            for (const label of currentLabels.data) {
              if (labelsToRemove.includes(label.name)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label.name
                });
              }
            }
            
            // Add new label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status: to be reviewed']
            });

  label-on-comment:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Add "status: in review" label
        uses: actions/github-script@v7
        with:
          script: |
            // Remove other status labels
            const labelsToRemove = ['status: to be reviewed', 'status: inactive'];
            const currentLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            for (const label of currentLabels.data) {
              if (labelsToRemove.includes(label.name)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label.name
                });
              }
            }
            
            // Add new label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status: in review']
            });

  label-on-review:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Handle review status
        uses: actions/github-script@v7
        with:
          script: |
            const review = context.payload.review;
            
            if (review.state === 'changes_requested') {
              // Remove other status labels
              const labelsToRemove = ['status: to be reviewed', 'status: in review', 'status: inactive'];
              const currentLabels = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              for (const label of currentLabels.data) {
                if (labelsToRemove.includes(label.name)) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: label.name
                  });
                }
              }
              
              // Add changes requested label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['status: pending-request-changes']
              });
            }

  check-conflicts:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Check for merge conflicts
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            if (pr.data.mergeable_state === 'dirty' || pr.data.mergeable === false) {
              // Add conflict label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['status: has-conflicts']
              });
            } else {
              // Remove conflict label if exists
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: 'status: has-conflicts'
                });
              } catch (error) {
                // Label doesn't exist, ignore
              }
            }

  check-inactive:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Mark inactive PRs
        uses: actions/github-script@v7
        with:
          script: |
            const fourWeeksAgo = new Date();
            fourWeeksAgo.setDate(fourWeeksAgo.getDate() - 28);
            
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            for (const pr of pullRequests) {
              const { data: events } = await github.rest.issues.listEvents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                per_page: 1
              });
              
              const lastActivityDate = events.length > 0 
                ? new Date(events[0].created_at)
                : new Date(pr.updated_at);
              
              if (lastActivityDate < fourWeeksAgo) {
                // Add inactive label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['status: inactive']
                });
              }
            }
